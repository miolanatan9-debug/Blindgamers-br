
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura Sonora Futurista</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #111;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        button {
            font-size: 1.5rem;
            padding: 20px;
            margin: 10px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background: #0ff;
            color: #111;
            font-weight: bold;
        }

        button:hover {
            background: #0dd;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.98);
        }

        button:focus {
            outline: 3px solid #0ff;
            outline-offset: 2px;
        }

        #menu {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #score-display {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        #game-message {
            font-size: 1.1rem;
            min-height: 50px; /* Para evitar layout shift */
        }

        /* Otimizado para acessibilidade */
        #status-announcer {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Aventura Sonora Futurista</h1>
        <button id="start-btn">Iniciar Jogo</button>
        <button id="settings-btn">Configura√ß√µes</button>
        <button id="credits-btn">Cr√©ditos</button>
    </div>

    <div id="game-container">
        <p id="score-display">Pontos: 0 | Vida: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è | N√≠vel: 1</p>
        <button id="jump-btn">PULAR!</button>
        <div id="game-message" aria-live="polite">Toque em PULAR para iniciar.</div>
        <button id="restart-btn" style="display:none;">Reiniciar Jogo</button>
    </div>

    <div id="status-announcer" aria-live="polite"></div>

    <script>
        // --- Elementos DOM ---
        const menu = document.getElementById('menu');
        const startBtn = document.getElementById('start-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const creditsBtn = document.getElementById('credits-btn');
        const gameContainer = document.getElementById('game-container');
        const jumpBtn = document.getElementById('jump-btn');
        const scoreDisplay = document.getElementById('score-display');
        const gameMessage = document.getElementById('game-message');
        const restartBtn = document.getElementById('restart-btn');
        const statusAnnouncer = document.getElementById('status-announcer');

        // --- √Åudio de Menu (HTML Audio) ---
        let menuMusic = new Audio("https://cdn.pixabay.com/download/audio/2023/03/27/audio_futuristic_background.mp3?filename=futuristic-background-12345.mp3");
        menuMusic.loop = true;
        menuMusic.volume = 0.5;

        let clickSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_click.mp3?filename=electronic_click-67890.mp3");
        clickSound.volume = 0.7;

        // --- Feedback ARIA ---
        function announce(message, isImportant = false) {
            statusAnnouncer.textContent = message;
            if (isImportant) {
                gameMessage.setAttribute('aria-live', 'assertive');
            } else {
                gameMessage.setAttribute('aria-live', 'polite');
            }
        }

        // --- Inicializa Menu ---
        function startMenu() {
            menuMusic.play().catch(e => console.log("A m√∫sica do menu aguarda intera√ß√£o."));
        }
        startMenu();

        // --- Sons de clique ---
        function playClick() {
            clickSound.currentTime = 0;
            clickSound.play();
        }

        // --- Menu bot√µes ---
        [startBtn, settingsBtn, creditsBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                playClick();
                announce(btn.textContent + " ativado.");
            });
        });

        // --- Configura√ß√µes do jogo ---
        let score = 0;
        let health = 3;
        let isJumping = false;
        let canJump = true;
        let gameLoopInterval;
        const GAME_SPEED = 10;
        const JUMP_DURATION = 800;
        const JUMP_COOLDOWN = 200;
        
        let currentLevel = 1;
        const MAX_LEVELS = 19; // N√≠vel 1 + 18 novos = 19
        const EVENT_SEGMENT_LENGTH = 7500; // Dist√¢ncia total para um "n√≠vel" ou segmento de eventos
        
        let levelEvents = [];
        let nextEventIndex = 0;
        let gamePosition = 0;
        let isRunning = false;

        /**
         * Gera um segmento de eventos de n√≠vel baseado na dificuldade.
         * N√≠veis mais altos t√™m menor 'minInterval' (dist√¢ncia entre eventos).
         */
        function generateLevelEvents(level) {
            const events = [];
            let currentDistance = 0;
            
            // Dificuldade: intervalo m√≠nimo entre eventos diminui com o n√≠vel
            const minInterval = Math.max(300, 1000 - (level * 50)); 
            const maxInterval = Math.max(500, 1500 - (level * 75));
            
            const obstacleTypes = ['hole', 'enemy'];
            const totalDistance = EVENT_SEGMENT_LENGTH;

            while (currentDistance < totalDistance) {
                // Adiciona uma moeda
                currentDistance += Math.floor(Math.random() * 200) + 300; 
                events.push([currentDistance, 'coin']);

                if (currentDistance >= totalDistance) break;

                // Adiciona um obst√°culo (buraco ou inimigo)
                const interval = Math.floor(Math.random() * (maxInterval - minInterval)) + minInterval;
                currentDistance += interval;

                if (currentDistance >= totalDistance) break;

                const obstacleType = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
                events.push([currentDistance, obstacleType]);
            }

            // Garante o marcador de fim de n√≠vel, ajustando para a dist√¢ncia total
            events.push([totalDistance, 'level_end']);

            // Filtra eventos duplicados ou muito pr√≥ximos e ordena
            return events.sort((a, b) => a[0] - b[0]);
        }


        // --- Tone.js setup ---
        let footstepsSynth, footstepsLoop, proximitySynth, jumpSynth, coinSynth, hitNoise;
        let isAudioSetup = false; 

        function setupAudio() {
            Tone.start();

            // 1. Passos (footsteps)
            footstepsSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 1,
                envelope: { attack: 0.01, decay: 0.2, sustain: 0 }
            }).toDestination();
            footstepsLoop = new Tone.Loop(time => {
                footstepsSynth.triggerAttackRelease("C1", "16n", time, 0.5); 
            }, "8n").stop();

            Tone.Transport.bpm.value = 120;

            // 2. Proximidade
            proximitySynth = new Tone.Synth({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.2 }
            }).toDestination();
            proximitySynth.volume.value = -Infinity;

            // 3. Pulo
            jumpSynth = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0 }
            }).toDestination();

            // 4. Moeda
            coinSynth = new Tone.MetalSynth({
                frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                harmonicity: 3.1, modulationIndex: 10, resonance: 4000, octaves: 0.5
            }).toDestination();

            // 5. Acerto/Dano
            hitNoise = new Tone.NoiseSynth({
                noise: { type: "brown" },
                envelope: { attack: 0.001, decay: 0.3, sustain: 0 }
            }).toDestination();
        }

        function ensureAudioSetup() {
            if (!isAudioSetup) {
                setupAudio();
                isAudioSetup = true;
            }
        }

        // --- Atualiza display ---
        function updateDisplay() {
            scoreDisplay.textContent = `Pontos: ${score} | Vida: ${'‚ù§Ô∏è'.repeat(health)}${'üñ§'.repeat(3 - health)} | N√≠vel: ${currentLevel}`;
        }

        // --- Fun√ß√µes do Jogo ---

        function handleJump() {
            ensureAudioSetup(); 
            if (!isRunning || isJumping || !canJump) return;

            isJumping = true;
            canJump = false;
            jumpBtn.textContent = "PULANDO...";
            announce("PULANDO!", true);

            jumpSynth.triggerAttackRelease("C4", 0.1);
            jumpSynth.triggerAttackRelease("G4", 0.1, Tone.now() + 0.1);

            if (navigator.vibrate) navigator.vibrate(50);

            setTimeout(() => {
                isJumping = false;
                jumpBtn.textContent = "PULAR!";
                announce("Retornou ao solo.");
                setTimeout(() => canJump = true, JUMP_COOLDOWN);
            }, JUMP_DURATION);
        }

        function handleCoin() {
            score += 100;
            updateDisplay();
            announce("Moeda Coletada!", true);
            coinSynth.triggerAttackRelease("C6", "16n");
            if (navigator.vibrate) navigator.vibrate(100);
        }

        function handleHit(type) {
            health--;
            updateDisplay();
            hitNoise.triggerAttackRelease("4n");
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            if (health <= 0) {
                endGame(`FIM DE JOGO! Voc√™ atingiu o ${type}. Pontua√ß√£o final: ${score}`);
            } else {
                announce(`Dano! Voc√™ atingiu o ${type}. Vida restante: ${health}`, true);
                gameMessage.textContent = `Cuidado! Voc√™ perdeu vida ao atingir o ${type}.`;
                
                isRunning = false;
                Tone.Transport.stop();
                if(footstepsLoop) footstepsLoop.stop(); 
                
                setTimeout(() => {
                    if (health > 0) {
                        isRunning = true;
                        Tone.Transport.start();
                        footstepsLoop.start(0);
                        gameMessage.textContent = "Jogo retomado.";
                    }
                }, 1000);
            }
        }

        function endGame(message) {
            isRunning = false;
            clearInterval(gameLoopInterval);
            Tone.Transport.stop();
            if(footstepsLoop) footstepsLoop.stop(); 
            gameMessage.textContent = message;
            jumpBtn.disabled = true;
            restartBtn.style.display = "block";
            announce(message);
        }

        /** Avan√ßa para o pr√≥ximo n√≠vel e gera novos eventos */
        function levelUp() {
            currentLevel++;
            if (currentLevel > MAX_LEVELS) {
                // Se completar todos os 19 n√≠veis (1 inicial + 18 novos)
                winGame(`PARAB√âNS! Voc√™ completou todos os ${MAX_LEVELS} n√≠veis!`);
                return;
            }

            isRunning = false;
            clearInterval(gameLoopInterval);
            Tone.Transport.stop();
            if(footstepsLoop) footstepsLoop.stop(); 

            // Gera o novo n√≠vel
            levelEvents = generateLevelEvents(currentLevel);
            nextEventIndex = 0;
            gamePosition = 0;

            updateDisplay();
            announce(`N√≠vel ${currentLevel} alcan√ßado! A dificuldade aumentou.`, true);
            gameMessage.textContent = `N√≠vel ${currentLevel} Iniciando... Prepare-se!`;

            // Pausa antes de recome√ßar o loop no novo n√≠vel
            setTimeout(() => {
                isRunning = true;
                gameLoopInterval = setInterval(gameLoop, 30);
                Tone.Transport.start();
                footstepsLoop.start(0);
                gameMessage.textContent = "N√≠vel em andamento. Escute e pule na hora certa.";
            }, 2000);
        }
        
        function winGame(message) {
            isRunning = false;
            clearInterval(gameLoopInterval);
            Tone.Transport.stop();
            if(footstepsLoop) footstepsLoop.stop(); 
            announce(message);
            gameMessage.textContent = message + ` Pontua√ß√£o final: ${score}`;
            jumpBtn.disabled = true;
            restartBtn.style.display = "block";
        }

        /** O principal loop de jogo */
        function gameLoop() {
            if (!isRunning) return;

            gamePosition += GAME_SPEED;
            let nextEvent = levelEvents[nextEventIndex];

            if (!nextEvent) {
                levelUp(); // Se n√£o h√° mais eventos, avan√ßa de n√≠vel
                return;
            }

            let eventDistance = nextEvent[0],
                eventType = nextEvent[1],
                distanceToNextEvent = eventDistance - gamePosition;

            // --- L√≥gica de Proximidade Sonora ---
            if (distanceToNextEvent > 0 && distanceToNextEvent <= 500) {
                const normalizedDistance = distanceToNextEvent / 500;
                const proximityVolume = Tone.gainToDb(1 - normalizedDistance) - 10;
                const proximityFrequency = 100 + (1 - normalizedDistance) * 300; 
                
                proximitySynth.volume.value = proximityVolume;
                proximitySynth.frequency.value = proximityFrequency;

                if (distanceToNextEvent > 470 && distanceToNextEvent < 500) { 
                    announce(`Alerta! ${eventType === 'hole' ? 'Buraco' : 'Inimigo'} √† frente.`, true);
                }
            } else {
                proximitySynth.volume.value = -Infinity;
            }

            // --- L√≥gica de Colis√£o/A√ß√£o ---
            if (distanceToNextEvent <= 0) {
                switch (eventType) {
                    case 'coin':
                        handleCoin();
                        break;
                    case 'hole':
                    case 'enemy':
                        if (!isJumping) {
                            handleHit(eventType === 'hole' ? 'buraco' : 'inimigo');
                        } else {
                            announce("Obst√°culo Superado!", true);
                            gameMessage.textContent = "Obst√°culo Superado! Pr√≥ximo desafio.";
                        }
                        break;
                    case 'level_end':
                        levelUp(); // Fim do segmento, avan√ßa de n√≠vel
                        return;
                }
                nextEventIndex++;
            }
        }

        // --- Inicializa√ß√£o e Controle do Jogo ---

        function startGame() {
            ensureAudioSetup();
            menuMusic.pause();

            menu.style.display = 'none';
            gameContainer.style.display = 'flex';

            // Resetar estado do jogo COMPLETO
            score = 0;
            health = 3;
            currentLevel = 1; 
            gamePosition = 0;
            nextEventIndex = 0;
            isJumping = false;
            canJump = true;
            isRunning = true;
            
            // Gera o primeiro n√≠vel
            levelEvents = generateLevelEvents(currentLevel); 

            clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameLoop, 30);

            // Inicia o √°udio do jogo
            Tone.Transport.start();
            if (footstepsLoop) footstepsLoop.start(0); 

            updateDisplay();
            gameMessage.textContent = "Jogo em andamento! Escute e pule na hora certa.";
            jumpBtn.disabled = false;
            restartBtn.style.display = "none";
            announce(`Jogo iniciado. N√≠vel ${currentLevel}. Escute os sons para pular.`);
        }

        // --- Eventos de UI ---
        startBtn.onclick = startGame;
        jumpBtn.onclick = handleJump;
        restartBtn.onclick = startGame;

        // --- Evento de Teclado (Barra de Espa√ßo) ---
        window.addEventListener('keydown', e => {
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                // Se n√£o estiver rodando E for o primeiro clique, inicia o jogo
                if (!isRunning && health === 3 && score === 0) {
                    startGame();
                } else {
                    handleJump();
                }
            }
        });
    </script>
</body>
</html>
